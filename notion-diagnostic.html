<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion API 診斷工具</title>
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: #f7f8fa;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .status {
            padding: 16px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
        }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .config {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            border: 1px solid #e9ecef;
        }
        .step {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 20px 0;
            padding: 20px;
        }
        .step h3 {
            margin-top: 0;
            color: #495057;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Notion API 深度診斷工具</h1>
        
        <div class="config">
            <strong>當前設定:</strong><br>
            Token: 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<br>
            Database ID: 22f2c142afa9807b896ad1c1d3cf315b<br>
            Database URL: <a href="https://www.notion.so/22f2c142afa9807b896ad1c1d3cf315b" target="_blank">在 Notion 中開啟</a>
        </div>

        <div class="step">
            <h3>步驟 1: 基本連接測試</h3>
            <p>測試 Notion API 的基本認證</p>
            <button onclick="testBasicAuth()">🔐 測試基本認證</button>
            <button onclick="testUserInfo()">👤 獲取用戶資訊</button>
        </div>

        <div class="step">
            <h3>步驟 2: Database 權限測試</h3>
            <p>檢查是否能存取指定的 Database</p>
            <button onclick="testDatabaseAccess()">📊 測試 Database 存取</button>
            <button onclick="listDatabasePages()">📄 列出 Database 頁面</button>
        </div>

        <div class="step">
            <h3>步驟 3: 寫入權限測試</h3>
            <p>測試是否能在 Database 中建立新頁面</p>
            <button onclick="createTestPage()">✏️ 建立測試頁面</button>
            <button onclick="createTestPageMinimal()">📝 建立最小測試頁面</button>
        </div>

        <div class="step">
            <h3>步驟 4: 錯誤診斷</h3>
            <p>檢查常見問題</p>
            <button onclick="diagnoseProblem()">🩺 自動診斷</button>
            <button onclick="showCommonSolutions()">💡 常見解決方案</button>
        </div>
        
        <div id="results"></div>

        <div class="step">
            <h3>🛠️ 設定檢查清單</h3>
            <div id="checklist">
                <p>⏳ 準備檢查...</p>
            </div>
        </div>
    </div>

    <script>
        const NOTION_TOKEN = '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';
        const DATABASE_ID = '22f2c142afa9807b896ad1c1d3cf315b';
        const NOTION_API_VERSION = '2022-06-28';
        const NOTION_BASE_URL = 'https://api.notion.com/v1';

        function showResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        async function testBasicAuth() {
            showResult('🔄 測試基本認證...', 'info');
            
            try {
                const response = await fetch(`${NOTION_BASE_URL}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${NOTION_TOKEN}`,
                        'Notion-Version': NOTION_API_VERSION
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(`✅ 認證成功! 用戶類型: ${data.type}`, 'success');
                    if (data.bot) {
                        showResult(`🤖 Bot 資訊: ${data.bot.owner?.user?.name || 'N/A'}`, 'info');
                    }
                } else {
                    showResult(`❌ 認證失敗: ${response.status} - ${data.message || JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                showResult(`❌ 網路錯誤: ${error.message}`, 'error');
            }
        }

        async function testUserInfo() {
            showResult('🔄 獲取詳細用戶資訊...', 'info');
            
            try {
                const response = await fetch(`${NOTION_BASE_URL}/users`, {
                    headers: {
                        'Authorization': `Bearer ${NOTION_TOKEN}`,
                        'Notion-Version': NOTION_API_VERSION
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(`✅ 用戶列表獲取成功! 總共 ${data.results.length} 個用戶`, 'success');
                    data.results.forEach(user => {
                        showResult(`👤 用戶: ${user.name || user.id} (${user.type})`, 'info');
                    });
                } else {
                    showResult(`❌ 獲取用戶資訊失敗: ${response.status} - ${data.message || JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                showResult(`❌ 網路錯誤: ${error.message}`, 'error');
            }
        }

        async function testDatabaseAccess() {
            showResult('🔄 測試 Database 存取權限...', 'info');
            
            try {
                const response = await fetch(`${NOTION_BASE_URL}/databases/${DATABASE_ID}`, {
                    headers: {
                        'Authorization': `Bearer ${NOTION_TOKEN}`,
                        'Notion-Version': NOTION_API_VERSION
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    const title = data.title[0]?.plain_text || 'N/A';
                    showResult(`✅ Database 存取成功! 標題: "${title}"`, 'success');
                    
                    // 顯示 properties
                    const properties = Object.keys(data.properties);
                    showResult(`📋 Database 欄位 (${properties.length}): ${properties.join(', ')}`, 'info');
                    
                    // 顯示詳細的 properties 結構
                    for (const [key, prop] of Object.entries(data.properties)) {
                        showResult(`🔸 ${key}: ${prop.type} ${prop.id === 'title' ? '(Title)' : ''}`, 'info');
                    }
                } else {
                    showResult(`❌ Database 存取失敗: ${response.status} - ${data.message || JSON.stringify(data)}`, 'error');
                    
                    if (response.status === 404) {
                        showResult(`💡 404 錯誤通常表示: 1) Database ID 錯誤 2) Integration 沒有權限存取此 Database`, 'warning');
                    }
                }
            } catch (error) {
                showResult(`❌ 網路錯誤: ${error.message}`, 'error');
            }
        }

        async function listDatabasePages() {
            showResult('🔄 列出 Database 中的頁面...', 'info');
            
            try {
                const response = await fetch(`${NOTION_BASE_URL}/databases/${DATABASE_ID}/query`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${NOTION_TOKEN}`,
                        'Notion-Version': NOTION_API_VERSION,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        page_size: 10
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(`✅ 成功查詢 Database! 找到 ${data.results.length} 個頁面`, 'success');
                    
                    if (data.results.length === 0) {
                        showResult(`📝 Database 目前是空的，這是正常的`, 'info');
                    } else {
                        data.results.forEach((page, index) => {
                            const title = Object.values(page.properties).find(p => p.type === 'title')?.title[0]?.plain_text || '無標題';
                            showResult(`📄 頁面 ${index + 1}: ${title}`, 'info');
                        });
                    }
                } else {
                    showResult(`❌ 查詢 Database 失敗: ${response.status} - ${data.message || JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                showResult(`❌ 網路錯誤: ${error.message}`, 'error');
            }
        }

        async function createTestPage() {
            showResult('🔄 嘗試建立測試頁面...', 'info');
            
            // 先取得 database schema
            try {
                const dbResponse = await fetch(`${NOTION_BASE_URL}/databases/${DATABASE_ID}`, {
                    headers: {
                        'Authorization': `Bearer ${NOTION_TOKEN}`,
                        'Notion-Version': NOTION_API_VERSION
                    }
                });

                if (!dbResponse.ok) {
                    showResult(`❌ 無法獲取 Database schema`, 'error');
                    return;
                }

                const dbData = await dbResponse.json();
                const properties = dbData.properties;
                
                // 建構符合 schema 的 properties
                const pageProperties = {};
                
                for (const [key, prop] of Object.entries(properties)) {
                    switch (prop.type) {
                        case 'title':
                            pageProperties[key] = {
                                title: [{ text: { content: `測試訂單-${Date.now()}` } }]
                            };
                            break;
                        case 'number':
                            pageProperties[key] = { number: Math.floor(Math.random() * 100) };
                            break;
                        case 'select':
                            // 使用第一個可用選項，或者創建一個
                            pageProperties[key] = { select: { name: 'pending' } };
                            break;
                        case 'date':
                            pageProperties[key] = { date: { start: new Date().toISOString() } };
                            break;
                        case 'rich_text':
                            pageProperties[key] = {
                                rich_text: [{ text: { content: '測試內容' } }]
                            };
                            break;
                    }
                }

                const response = await fetch(`${NOTION_BASE_URL}/pages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${NOTION_TOKEN}`,
                        'Notion-Version': NOTION_API_VERSION,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        parent: { database_id: DATABASE_ID },
                        properties: pageProperties
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(`✅ 測試頁面建立成功! 🎉`, 'success');
                    showResult(`🔗 <a href="${data.url}" target="_blank">在 Notion 中查看</a>`, 'info');
                } else {
                    showResult(`❌ 建立頁面失敗: ${response.status} - ${data.message || JSON.stringify(data)}`, 'error');
                    
                    if (data.message && data.message.includes('validation')) {
                        showResult(`💡 Validation 錯誤通常表示 properties 格式不正確`, 'warning');
                    }
                }
            } catch (error) {
                showResult(`❌ 錯誤: ${error.message}`, 'error');
            }
        }

        async function createTestPageMinimal() {
            showResult('🔄 建立最小測試頁面 (僅 title)...', 'info');
            
            try {
                const response = await fetch(`${NOTION_BASE_URL}/pages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${NOTION_TOKEN}`,
                        'Notion-Version': NOTION_API_VERSION,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        parent: { database_id: DATABASE_ID },
                        properties: {
                            'Name': {
                                title: [{ text: { content: `簡單測試-${Date.now()}` } }]
                            }
                        }
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showResult(`✅ 最小測試頁面建立成功! 🎉`, 'success');
                    showResult(`🔗 <a href="${data.url}" target="_blank">在 Notion 中查看</a>`, 'info');
                } else {
                    showResult(`❌ 建立最小頁面失敗: ${response.status} - ${data.message || JSON.stringify(data)}`, 'error');
                    showResult(`📝 錯誤詳情: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`❌ 錯誤: ${error.message}`, 'error');
            }
        }

        async function diagnoseProblem() {
            showResult('🩺 開始自動診斷...', 'info');
            
            const checks = [
                { name: 'Token 格式', test: () => NOTION_TOKEN.startsWith('ntn_') },
                { name: 'Database ID 格式', test: () => /^[a-f0-9]{32}$/i.test(DATABASE_ID) },
                { name: 'API 版本', test: () => NOTION_API_VERSION === '2022-06-28' }
            ];
            
            for (const check of checks) {
                const result = check.test();
                showResult(`${result ? '✅' : '❌'} ${check.name}: ${result ? '正確' : '有問題'}`, result ? 'success' : 'error');
            }
            
            // 測試網路連接
            try {
                const response = await fetch(NOTION_BASE_URL);
                showResult(`✅ Notion API 端點可達`, 'success');
            } catch (error) {
                showResult(`❌ 無法連接到 Notion API`, 'error');
            }
        }

        function showCommonSolutions() {
            const solutions = `
                <div class="code-block">
                <strong>常見問題與解決方案:</strong><br><br>
                
                <strong>1. 404 錯誤 - Database 不存在</strong><br>
                • 檢查 Database ID 是否正確<br>
                • 確認 Integration 有權限存取該 Database<br>
                • 在 Notion 中分享 Database 給 Integration<br><br>
                
                <strong>2. 401 錯誤 - 認證失敗</strong><br>
                • 檢查 Token 是否正確<br>
                • 確認 Token 以 'ntn_' 開頭<br>
                • 重新生成 Integration Token<br><br>
                
                <strong>3. 403 錯誤 - 權限不足</strong><br>
                • 確認 Integration 有「Insert content」權限<br>
                • 檢查 Database 是否已分享給 Integration<br><br>
                
                <strong>4. Validation 錯誤</strong><br>
                • 檢查 properties 格式是否符合 Database schema<br>
                • 確認必填欄位都有提供<br>
                • 檢查 select 選項是否存在於 Database 中<br><br>
                
                <strong>正確的分享步驟:</strong><br>
                1. 在 Notion 中開啟您的 Database<br>
                2. 點擊右上角的「...」選單<br>
                3. 選擇「Add connections」<br>
                4. 搜尋並選擇您的 Integration<br>
                5. 點擊「Allow access」
                </div>
            `;
            showResult(solutions, 'info');
        }

        // 頁面載入時自動開始診斷
        window.onload = function() {
            showResult('🚀 Notion API 診斷工具已啟動', 'info');
            
            // 自動檢查基本設定
            setTimeout(() => {
                const checklist = document.getElementById('checklist');
                const checks = [
                    `✅ Token 格式: ${NOTION_TOKEN.startsWith('ntn_') ? '正確' : '❌ 錯誤'}`,
                    `✅ Database ID 格式: ${/^[a-f0-9]{32}$/i.test(DATABASE_ID) ? '正確' : '❌ 錯誤'}`,
                    `✅ API 版本: ${NOTION_API_VERSION}`,
                    `🔗 Database URL: <a href="https://www.notion.so/${DATABASE_ID}" target="_blank">點擊檢查</a>`
                ];
                checklist.innerHTML = checks.join('<br>');
            }, 1000);
            
            // 自動測試基本認證
            setTimeout(testBasicAuth, 2000);
        };
    </script>
</body>
</html>